name: æ„å»ºè·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-13
            platform: macOS
            arch: x86_64
            runner_arch: intel
            executable_suffix: ""
          - os: macos-latest
            platform: macOS
            arch: arm64
            runner_arch: apple_silicon
            executable_suffix: ""
          - os: windows-latest
            platform: Windows
            arch: x86_64
            runner_arch: x86_64
            executable_suffix: ".exe"
          - os: ubuntu-latest
            platform: Linux
            arch: x86_64
            runner_arch: x86_64
            executable_suffix: ""

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=5.0
        
    - name: éªŒè¯Pythonç¯å¢ƒ
      run: |
        python --version
        pip list

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "amap-downloader" --hidden-import tkinter --hidden-import tkinter.ttk --hidden-import tkinter.messagebox --hidden-import tkinter.filedialog --hidden-import requests --hidden-import json --hidden-import pathlib --hidden-import threading --hidden-import urllib.parse --hidden-import urllib.request --hidden-import urllib.error --exclude-module matplotlib --exclude-module numpy --exclude-module pandas --exclude-module scipy --exclude-module PIL --exclude-module cv2 --exclude-module tensorflow --exclude-module torch --exclude-module jupyter --exclude-module IPython --add-data "config_example.py;." --add-data "ä½¿ç”¨è¯´æ˜.md;." map_downloader_gui.py

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (macOS Intel)
      if: matrix.os == 'macos-13'
      run: |
        # macOS Intel (x86_64) æ„å»º
        echo "æ„å»º macOS Intel (x86_64) ç‰ˆæœ¬"
        pyinstaller --onefile --windowed --name "amap-downloader" \
          --target-arch x86_64 \
          --hidden-import tkinter \
          --hidden-import tkinter.ttk \
          --hidden-import tkinter.messagebox \
          --hidden-import tkinter.filedialog \
          --hidden-import requests \
          --hidden-import json \
          --hidden-import pathlib \
          --hidden-import threading \
          --hidden-import urllib.parse \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --hidden-import ssl \
          --hidden-import certifi \
          --hidden-import charset_normalizer \
          --hidden-import idna \
          --exclude-module matplotlib \
          --exclude-module numpy \
          --exclude-module pandas \
          --exclude-module scipy \
          --exclude-module PIL \
          --exclude-module cv2 \
          --exclude-module tensorflow \
          --exclude-module torch \
          --exclude-module jupyter \
          --exclude-module IPython \
          --add-data "config_example.py:." \
          --add-data "ä½¿ç”¨è¯´æ˜.md:." \
          --osx-bundle-identifier "com.amapdownloader.app" \
          --codesign-identity "-" \
          map_downloader_gui.py

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (macOS Apple Silicon)
      if: matrix.os == 'macos-latest'
      run: |
        # macOS Apple Silicon (arm64) æ„å»º
        echo "æ„å»º macOS Apple Silicon (arm64) ç‰ˆæœ¬"
        pyinstaller --onefile --windowed --name "amap-downloader" \
          --target-arch arm64 \
          --hidden-import tkinter \
          --hidden-import tkinter.ttk \
          --hidden-import tkinter.messagebox \
          --hidden-import tkinter.filedialog \
          --hidden-import requests \
          --hidden-import json \
          --hidden-import pathlib \
          --hidden-import threading \
          --hidden-import urllib.parse \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --hidden-import ssl \
          --hidden-import certifi \
          --hidden-import charset_normalizer \
          --hidden-import idna \
          --exclude-module matplotlib \
          --exclude-module numpy \
          --exclude-module pandas \
          --exclude-module scipy \
          --exclude-module PIL \
          --exclude-module cv2 \
          --exclude-module tensorflow \
          --exclude-module torch \
          --exclude-module jupyter \
          --exclude-module IPython \
          --add-data "config_example.py:." \
          --add-data "ä½¿ç”¨è¯´æ˜.md:." \
          --osx-bundle-identifier "com.amapdownloader.app" \
          --codesign-identity "-" \
          map_downloader_gui.py

    - name: è®¾ç½®macOSå¯æ‰§è¡Œæ–‡ä»¶æƒé™
      if: startsWith(matrix.os, 'macos')
      run: |
        cd dist
        chmod +x amap-downloader
        echo "è®¾ç½®macOSå¯æ‰§è¡Œæ–‡ä»¶æƒé™å®Œæˆ"
        echo "æ–‡ä»¶æ¶æ„ä¿¡æ¯ï¼š"
        file amap-downloader
        ls -la amap-downloader

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        pyinstaller --onefile --windowed --name "amap-downloader" \
          --hidden-import tkinter \
          --hidden-import tkinter.ttk \
          --hidden-import tkinter.messagebox \
          --hidden-import tkinter.filedialog \
          --hidden-import requests \
          --hidden-import json \
          --hidden-import pathlib \
          --hidden-import threading \
          --hidden-import urllib.parse \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --exclude-module matplotlib \
          --exclude-module numpy \
          --exclude-module pandas \
          --exclude-module scipy \
          --exclude-module PIL \
          --exclude-module cv2 \
          --exclude-module tensorflow \
          --exclude-module torch \
          --exclude-module jupyter \
          --exclude-module IPython \
          --add-data "config_example.py:." \
          --add-data "ä½¿ç”¨è¯´æ˜.md:." \
          map_downloader_gui.py

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
      shell: bash
      run: |
        cd dist
        echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        ls -la
        
        # è®¾ç½®ç›®æ ‡æ–‡ä»¶å
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          target_name="amap-downloader_${{ matrix.platform }}_${{ matrix.arch }}.exe"
          # æŸ¥æ‰¾.exeæ–‡ä»¶å¹¶é‡å‘½å
          if [ -f "amap-downloader.exe" ]; then
            echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: amap-downloader.exe"
            mv "amap-downloader.exe" "$target_name"
            echo "é‡å‘½åä¸º: $target_name"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° amap-downloader.exe"
            ls -la
            exit 1
          fi
        else
          # ä¸ºmacOSæ·»åŠ æ¶æ„åç¼€ä»¥åŒºåˆ†Intelå’ŒApple Siliconç‰ˆæœ¬
          if [ "${{ matrix.platform }}" = "macOS" ]; then
            if [ "${{ matrix.arch }}" = "x86_64" ]; then
              target_name="amap-downloader_${{ matrix.platform }}_Intel"
            else
              target_name="amap-downloader_${{ matrix.platform }}_AppleSilicon"
            fi
          else
            target_name="amap-downloader_${{ matrix.platform }}_${{ matrix.arch }}"
          fi
          
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶å¹¶é‡å‘½å
          if [ -f "amap-downloader" ]; then
            echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: amap-downloader"
            mv "amap-downloader" "$target_name"
            echo "é‡å‘½åä¸º: $target_name"
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° amap-downloader"
            ls -la
            exit 1
          fi
        fi
        
        echo "é‡å‘½ååçš„æ–‡ä»¶ï¼š"
        ls -la

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: amap-downloader-${{ matrix.platform }}-${{ matrix.runner_arch }}
        path: dist/amap-downloader_*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
      run: ls -la
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        name: é«˜å¾·åœ°å›¾ä¸‹è½½å™¨ ${{ github.ref_name }}
        body: |
          ## é«˜å¾·åœ°å›¾ä¸‹è½½å™¨ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `amap-downloader_Windows_x86_64.exe`
          - **macOS Intelç”¨æˆ·**: ä¸‹è½½ `amap-downloader_macOS_Intel`
          - **macOS Apple Siliconç”¨æˆ·**: ä¸‹è½½ `amap-downloader_macOS_AppleSilicon`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `amap-downloader_Linux_x86_64`
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆmacOS/Linuxç”¨æˆ·å¯èƒ½éœ€è¦å…ˆæ·»åŠ æ‰§è¡Œæƒé™ï¼‰
          3. æŒ‰ç…§ç•Œé¢æç¤ºè¿›è¡Œæ“ä½œ
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆè¯´æ˜ã€‚
        files: |
          amap-downloader_macOS_Intel
          amap-downloader_macOS_AppleSilicon
          amap-downloader_Windows_x86_64.exe
          amap-downloader_Linux_x86_64
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}