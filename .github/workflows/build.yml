name: 构建跨平台可执行文件

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macOS
            arch: x86_64
            executable_suffix: ""
          - os: windows-latest
            platform: Windows
            arch: x86_64
            executable_suffix: ".exe"
          - os: ubuntu-latest
            platform: Linux
            arch: x86_64
            executable_suffix: ""

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=5.0
        
    - name: 验证Python环境
      run: |
        python --version
        pip list

    - name: 构建可执行文件 (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "高德地图下载器" --hidden-import tkinter --hidden-import tkinter.ttk --hidden-import tkinter.messagebox --hidden-import tkinter.filedialog --hidden-import requests --hidden-import json --hidden-import pathlib --hidden-import threading --hidden-import urllib.parse --hidden-import urllib.request --hidden-import urllib.error --exclude-module matplotlib --exclude-module numpy --exclude-module pandas --exclude-module scipy --exclude-module PIL --exclude-module cv2 --exclude-module tensorflow --exclude-module torch --exclude-module jupyter --exclude-module IPython --add-data "config_example.py;." --add-data "使用说明.md;." map_downloader_gui.py

    - name: 构建可执行文件 (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "高德地图下载器" \
          --hidden-import tkinter \
          --hidden-import tkinter.ttk \
          --hidden-import tkinter.messagebox \
          --hidden-import tkinter.filedialog \
          --hidden-import requests \
          --hidden-import json \
          --hidden-import pathlib \
          --hidden-import threading \
          --hidden-import urllib.parse \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --exclude-module matplotlib \
          --exclude-module numpy \
          --exclude-module pandas \
          --exclude-module scipy \
          --exclude-module PIL \
          --exclude-module cv2 \
          --exclude-module tensorflow \
          --exclude-module torch \
          --exclude-module jupyter \
          --exclude-module IPython \
          --add-data "config_example.py:." \
          --add-data "使用说明.md:." \
          map_downloader_gui.py

    - name: 重命名可执行文件
      shell: bash
      run: |
        cd dist
        echo "构建产物列表："
        ls -la
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          mv "高德地图下载器.exe" "高德地图下载器_${{ matrix.platform }}_${{ matrix.arch }}.exe"
        else
          mv "高德地图下载器" "高德地图下载器_${{ matrix.platform }}_${{ matrix.arch }}"
        fi
        echo "重命名后的文件："
        ls -la

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: 高德地图下载器_${{ matrix.platform }}_${{ matrix.arch }}
        path: dist/高德地图下载器_${{ matrix.platform }}_${{ matrix.arch }}${{ matrix.executable_suffix }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: 列出下载的文件
      run: ls -la
      
    - name: 创建发布
      uses: softprops/action-gh-release@v1
      with:
        files: |
          高德地图下载器_macOS_x86_64
          高德地图下载器_Windows_x86_64.exe
          高德地图下载器_Linux_x86_64
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}