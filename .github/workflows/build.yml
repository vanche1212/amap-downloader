name: æ„å»ºè·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macOS
            arch: x86_64
            executable_suffix: ""
          - os: windows-latest
            platform: Windows
            arch: x86_64
            executable_suffix: ".exe"
          - os: ubuntu-latest
            platform: Linux
            arch: x86_64
            executable_suffix: ""

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=5.0
        
    - name: éªŒè¯Pythonç¯å¢ƒ
      run: |
        python --version
        pip list

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "é«˜å¾·åœ°å›¾ä¸‹è½½å™¨" --hidden-import tkinter --hidden-import tkinter.ttk --hidden-import tkinter.messagebox --hidden-import tkinter.filedialog --hidden-import requests --hidden-import json --hidden-import pathlib --hidden-import threading --hidden-import urllib.parse --hidden-import urllib.request --hidden-import urllib.error --exclude-module matplotlib --exclude-module numpy --exclude-module pandas --exclude-module scipy --exclude-module PIL --exclude-module cv2 --exclude-module tensorflow --exclude-module torch --exclude-module jupyter --exclude-module IPython --add-data "config_example.py;." --add-data "ä½¿ç”¨è¯´æ˜.md;." map_downloader_gui.py

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "é«˜å¾·åœ°å›¾ä¸‹è½½å™¨" \
          --hidden-import tkinter \
          --hidden-import tkinter.ttk \
          --hidden-import tkinter.messagebox \
          --hidden-import tkinter.filedialog \
          --hidden-import requests \
          --hidden-import json \
          --hidden-import pathlib \
          --hidden-import threading \
          --hidden-import urllib.parse \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --exclude-module matplotlib \
          --exclude-module numpy \
          --exclude-module pandas \
          --exclude-module scipy \
          --exclude-module PIL \
          --exclude-module cv2 \
          --exclude-module tensorflow \
          --exclude-module torch \
          --exclude-module jupyter \
          --exclude-module IPython \
          --add-data "config_example.py:." \
          --add-data "ä½¿ç”¨è¯´æ˜.md:." \
          map_downloader_gui.py

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
      shell: bash
      run: |
        cd dist
        echo "æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
        ls -la
        
        # è®¾ç½®ç›®æ ‡æ–‡ä»¶å
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          target_name="é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_${{ matrix.platform }}_${{ matrix.arch }}.exe"
          # æŸ¥æ‰¾.exeæ–‡ä»¶å¹¶é‡å‘½å
          for file in *.exe; do
            if [ -f "$file" ]; then
              echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $file"
              mv "$file" "$target_name"
              echo "é‡å‘½åä¸º: $target_name"
              break
            fi
          done
        else
          target_name="é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_${{ matrix.platform }}_${{ matrix.arch }}"
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶å¹¶é‡å‘½å
          for file in *; do
            if [ -f "$file" ] && [ -x "$file" ] && [[ "$file" != *.* ]]; then
              echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $file"
              mv "$file" "$target_name"
              echo "é‡å‘½åä¸º: $target_name"
              break
            fi
          done
        fi
        
        echo "é‡å‘½ååçš„æ–‡ä»¶ï¼š"
        ls -la

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: amap-downloader-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_${{ matrix.platform }}_${{ matrix.arch }}${{ matrix.executable_suffix }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
      run: ls -la
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        name: é«˜å¾·åœ°å›¾ä¸‹è½½å™¨ ${{ github.ref_name }}
        body: |
          ## é«˜å¾·åœ°å›¾ä¸‹è½½å™¨ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_Windows_x86_64.exe`
          - **macOSç”¨æˆ·**: ä¸‹è½½ `é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_macOS_x86_64`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_Linux_x86_64`
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆmacOS/Linuxç”¨æˆ·å¯èƒ½éœ€è¦å…ˆæ·»åŠ æ‰§è¡Œæƒé™ï¼‰
          3. æŒ‰ç…§ç•Œé¢æç¤ºè¿›è¡Œæ“ä½œ
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆè¯´æ˜ã€‚
        files: |
          é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_macOS_x86_64
          é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_Windows_x86_64.exe
          é«˜å¾·åœ°å›¾ä¸‹è½½å™¨_Linux_x86_64
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}